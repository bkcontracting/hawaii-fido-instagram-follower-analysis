#!/usr/bin/env python3
"""
Convert CSV files to JavaScript data modules.

This script reads the dashboard configuration and converts all specified CSV
files into a single JavaScript file containing all data as embedded objects.

Usage:
    python3 csv-to-js.py
"""

import csv
import json
import sys
from pathlib import Path


def csv_to_array(csv_path):
    """
    Convert CSV file to list of dictionaries.

    Args:
        csv_path: Path to CSV file

    Returns:
        List of dictionaries representing CSV rows
    """
    data = []
    with open(csv_path, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            data.append(row)
    return data


def build_data_module(config_path, output_path):
    """
    Read config and generate JavaScript data module for all CSVs.

    Args:
        config_path: Path to dashboard-config.json
        output_path: Path for output data.js file

    Returns:
        Number of datasets processed
    """
    # Load configuration
    with open(config_path, 'r', encoding='utf-8') as f:
        config = json.load(f)

    # Process each tab's CSV file
    all_data = {}
    for tab in config['tabs']:
        csv_file = tab['csvFile']
        csv_path = Path('output') / csv_file

        if not csv_path.exists():
            print(f"‚ùå ERROR: CSV file not found: {csv_path}", file=sys.stderr)
            print(f"   Expected location: /home/user/hawaii-fido-instagram-follower-analysis/{csv_path}", file=sys.stderr)
            sys.exit(1)

        try:
            tab_data = csv_to_array(csv_path)
            all_data[tab['id']] = tab_data
            print(f"‚úì Loaded {len(tab_data)} records from {csv_file}")
        except Exception as e:
            print(f"‚ùå ERROR reading {csv_file}: {e}", file=sys.stderr)
            sys.exit(1)

    # Generate JavaScript module
    js_output = "// AUTO-GENERATED - DO NOT EDIT\n"
    js_output += "// This file contains embedded follower data and dashboard configuration\n"
    js_output += "// Generated by dashboard/build/csv-to-js.py\n\n"

    # Embed configuration
    js_output += f"const DASHBOARD_CONFIG = {json.dumps(config, indent=2)};\n\n"

    # Embed data for all tabs
    js_output += "const DASHBOARD_DATA = {\n"
    for tab_id, data in all_data.items():
        js_output += f"  '{tab_id}': {json.dumps(data, indent=4)},\n"
    js_output += "};\n"

    # Write to output file
    output_path = Path(output_path)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(js_output)

    file_size = output_path.stat().st_size / 1024  # KB
    print(f"\n‚úÖ Generated {output_path} ({file_size:.1f} KB)")
    print(f"   Contains {len(all_data)} datasets with {sum(len(d) for d in all_data.values())} total records")

    return len(all_data)


def main():
    """Main entry point."""
    # Determine project root
    project_root = Path(__file__).parent.parent.parent

    config_path = project_root / 'dashboard' / 'config' / 'dashboard-config.json'
    output_path = project_root / 'dashboard' / 'dist' / 'data.js'

    if not config_path.exists():
        print(f"‚ùå ERROR: Configuration file not found: {config_path}", file=sys.stderr)
        sys.exit(1)

    print("üìä Converting CSVs to JavaScript...")
    print(f"Config: {config_path}")
    print(f"Output: {output_path}\n")

    build_data_module(config_path, output_path)


if __name__ == '__main__':
    main()

#!/usr/bin/env python3
"""
Generate self-contained HTML dashboard from templates.

This script combines HTML template, CSS, JavaScript, and embedded data into a
single self-contained HTML file that can be deployed as a static page.

Usage:
    python3 generate-html.py
"""

import json
from pathlib import Path
from string import Template
import sys


def load_template(template_path):
    """Load HTML template file."""
    if not template_path.exists():
        raise FileNotFoundError(f"Template not found: {template_path}")
    return Template(template_path.read_text(encoding='utf-8'))


def load_file(file_path):
    """Load text file content."""
    if not file_path.exists():
        raise FileNotFoundError(f"File not found: {file_path}")
    return file_path.read_text(encoding='utf-8')


def generate_html(config_path, template_path, css_path, js_path, data_js_path, output_path):
    """
    Generate self-contained HTML dashboard.

    Args:
        config_path: Path to dashboard-config.json
        template_path: Path to template.html
        css_path: Path to styles.css
        js_path: Path to app.js
        data_js_path: Path to data.js (generated by csv-to-js.py)
        output_path: Path for output index.html

    Returns:
        Size of generated file in KB
    """
    print("üé® Generating HTML dashboard...")

    # Load configuration
    with open(config_path, 'r', encoding='utf-8') as f:
        config = json.load(f)

    print(f"‚úì Loaded configuration: {config['dashboardTitle']}")

    # Load all components
    try:
        template = load_template(template_path)
        css_content = load_file(css_path)
        app_js = load_file(js_path)
        data_js = load_file(data_js_path)

        print(f"‚úì Loaded HTML template ({len(template.template)} chars)")
        print(f"‚úì Loaded CSS ({len(css_content)} chars)")
        print(f"‚úì Loaded JavaScript ({len(app_js)} chars)")
        print(f"‚úì Loaded data module ({len(data_js)} chars)")

    except FileNotFoundError as e:
        print(f"‚ùå ERROR: {e}", file=sys.stderr)
        sys.exit(1)

    # Replace placeholders in template
    try:
        final_html = template.substitute(
            DASHBOARD_TITLE=config['dashboardTitle'],
            CSS_CONTENT=css_content,
            DATA_JS=data_js,
            APP_JS=app_js
        )
    except KeyError as e:
        print(f"‚ùå ERROR: Missing placeholder in template: {e}", file=sys.stderr)
        sys.exit(1)

    # Validate no unreplaced placeholders
    if '{{' in final_html or '}}' in final_html:
        print("‚ö†Ô∏è  WARNING: Unreplaced placeholders found in output", file=sys.stderr)

    # Write output
    output_path = Path(output_path)
    output_path.parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, 'w', encoding='utf-8') as f:
        f.write(final_html)

    file_size = output_path.stat().st_size / 1024  # KB
    print(f"\n‚úÖ Generated {output_path} ({file_size:.1f} KB)")

    return file_size


def main():
    """Main entry point."""
    # Determine project root
    project_root = Path(__file__).parent.parent.parent

    config_path = project_root / 'dashboard' / 'config' / 'dashboard-config.json'
    template_path = project_root / 'dashboard' / 'src' / 'template.html'
    css_path = project_root / 'dashboard' / 'src' / 'styles.css'
    js_path = project_root / 'dashboard' / 'src' / 'app.js'
    data_js_path = project_root / 'dashboard' / 'dist' / 'data.js'
    output_path = project_root / 'dashboard' / 'dist' / 'index.html'

    print(f"Config: {config_path}")
    print(f"Template: {template_path}")
    print(f"Output: {output_path}\n")

    file_size = generate_html(
        config_path,
        template_path,
        css_path,
        js_path,
        data_js_path,
        output_path
    )

    # Final validation
    if file_size > 1000:  # > 1MB
        print(f"‚ö†Ô∏è  WARNING: Output file is large ({file_size:.1f} KB)")
        print("   Consider optimizing data or enabling compression")


if __name__ == '__main__':
    main()
